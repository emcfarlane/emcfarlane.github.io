<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Edward McFarlane Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Edward McFarlane Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><title data-react-helmet="true">A Web App Framework | Edward McFarlane</title><meta data-react-helmet="true" property="og:title" content="A Web App Framework | Edward McFarlane"><meta data-react-helmet="true" name="description" content="This is documentation, for me essentially, on how to deploy a web application."><meta data-react-helmet="true" property="og:description" content="This is documentation, for me essentially, on how to deploy a web application."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.5bc33aa8.css">
<link rel="preload" href="/styles.3afe586c.js" as="script">
<link rel="preload" href="/runtime~main.00845c9c.js" as="script">
<link rel="preload" href="/main.74982311.js" as="script">
<link rel="preload" href="/1.48443e6e.js" as="script">
<link rel="preload" href="/2.0385acc6.js" as="script">
<link rel="preload" href="/ccc49370.c39886c3.js" as="script">
<link rel="preload" href="/ffe4a5f6.6803eb02.js" as="script">
<link rel="preload" href="/80bd3654.fd062ed7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Edward McFarlane</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/edward-mcfarlane-b5493375/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-linkedin header-logo"></a><a href="https://twitter.com/EdwardMcFarlane" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter header-logo"></a><a href="https://www.instagram.com/edwardmcfarlane/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-instagram header-logo"></a><a href="https://github.com/emcfarlane" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github header-logo"></a><span class="displayOnlyInLargeViewport_2N3Q" aria-label="Dark mode toggle"></span></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Edward McFarlane</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://www.linkedin.com/in/edward-mcfarlane-b5493375/" target="_blank" rel="noopener noreferrer" class="menu__link header-linkedin header-logo"></a></li><li class="menu__list-item"><a href="https://twitter.com/EdwardMcFarlane" target="_blank" rel="noopener noreferrer" class="menu__link header-twitter header-logo"></a></li><li class="menu__list-item"><a href="https://www.instagram.com/edwardmcfarlane/" target="_blank" rel="noopener noreferrer" class="menu__link header-instagram header-logo"></a></li><li class="menu__list-item"><a href="https://github.com/emcfarlane" target="_blank" rel="noopener noreferrer" class="menu__link header-github header-logo"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/sqlitex">SQLite Search</a></li><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/webapps">A Web App Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/goldfish">Goldfish Memory</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/swash-plate">Cyclic/Collective Pitch Mixing</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/ipad-dev">An iPad with Tailscale</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">A Web App Framework</h1><div class="margin-vert--md"><time datetime="2021-06-01T00:00:00.000Z" class="blogPostDate_Ta7i">June 1, 2021  Â· 6 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><section class="markdown"><p>This is documentation, for me essentially, on how to deploy a web application.
It&#x27;s opinionated and will change over time. Here are the buzz words:</p><ul><li>Next.js</li><li>Typescript</li><li>Progressive Web App (PWA)</li><li>Go</li><li>Google Cloud Run (Serverless)</li><li>Firebase</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="nextjs-guide"></a>NextJS Guide<a class="hash-link" href="#nextjs-guide" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup-nextjs"></a>Setup Next.js<a class="hash-link" href="#setup-nextjs" title="Direct link to heading">#</a></h3><p>Nextjs make react simple and configurable to set up. Docs are <a href="https://nextjs.org/docs" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup-typescript"></a>Setup Typescript<a class="hash-link" href="#setup-typescript" title="Direct link to heading">#</a></h3><p>Docs are <a href="https://nextjs.org/docs/basic-features/typescript" target="_blank" rel="noopener noreferrer">here</a>
You will want to install the types as dev dependencies:
<code>npm install --save-dev typescript @types/react</code>.</p><p><code>tsconfig.json</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;compilerOptions&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;target&quot;: &quot;es5&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;lib&quot;: [&quot;dom&quot;, &quot;dom.iterable&quot;, &quot;esnext&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;allowJs&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;skipLibCheck&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;strict&quot;: false,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;forceConsistentCasingInFileNames&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;noEmit&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;esModuleInterop&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;module&quot;: &quot;esnext&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;moduleResolution&quot;: &quot;node&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;resolveJsonModule&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;isolatedModules&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;jsx&quot;: &quot;preserve&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;exclude&quot;: [&quot;node_modules&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;include&quot;: [&quot;next-env.d.ts&quot;, &quot;**/*.ts&quot;, &quot;**/*.tsx&quot;]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup-pwa"></a>Setup PWA<a class="hash-link" href="#setup-pwa" title="Direct link to heading">#</a></h3><p>Progressive Web Apps. Docs are <a href="https://www.npmjs.com/package/next-pwa" target="_blank" rel="noopener noreferrer">here</a>.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">const withPWA = require(&quot;next-pwa&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = withPWA({</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pwa: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dest: &quot;public&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  async rewrites() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source: &quot;/api/:path*&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        destination: &quot;http://localhost:8000/:path*&quot;, // Proxy to Backend</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The important part is the local <code>/api</code> redirect for developement.
This redirects all <code>/api</code> calls to your local backend service.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup-tailwindcss"></a>Setup Tailwindcss<a class="hash-link" href="#setup-tailwindcss" title="Direct link to heading">#</a></h3><p>Docs are <a href="https://tailwindcss.com/docs/guides/nextjs" target="_blank" rel="noopener noreferrer">here</a>.
You need to create the  <code>tailwind.config.js</code> and <code>postcss.config.js</code> files.</p><p>I recommend to keep the global <code>styles.css</code> so you can still bundle classes together.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="setup-darkmode"></a>Setup Darkmode<a class="hash-link" href="#setup-darkmode" title="Direct link to heading">#</a></h3><p>Support for dark mode is nice.
<a href="https://www.npmjs.com/package/next-themes" target="_blank" rel="noopener noreferrer"><code>next-themes</code></a> provides this out of the box.</p><p>Ensure your <code>tailwind.config.js</code> adds support via the darkmode class:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">module.exports = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  darkMode: &quot;class&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Add <code>color-scheme</code> support to your <code>styles.css</code>. More info on <a href="https://web.dev/color-scheme/" target="_blank" rel="noopener noreferrer">web.dev</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="firebase"></a>Firebase<a class="hash-link" href="#firebase" title="Direct link to heading">#</a></h2><p>Firebase is a useful application framework. It has good support for mobile apps to.
The web sdks are nice. The main benefit I see is for authentication.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="api"></a>API<a class="hash-link" href="#api" title="Direct link to heading">#</a></h2><p>I&#x27;m a big fan of protobuffers and gRPC. It&#x27;s well defined and simple with a lot
of best practises built in. However it&#x27;s typically not been usefull for any
front end work as the internal protocol of gRPC is based on binary HTTP2 with
trailing headers that aren&#x27;t supported in the browser. Although now there are
a couple options:</p><ul><li>gRPC Web</li><li>REST Transcoding</li></ul><p>My preferred is transcoding. It gives a nice <em>RESTful</em> style api that doesn&#x27;t feel like a generated API.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="larking"></a>Larking<a class="hash-link" href="#larking" title="Direct link to heading">#</a></h3><p><a href="https://github.com/emcfarlane/larking" target="_blank" rel="noopener noreferrer">Larking</a> is my transcoding project.
It uses the new <a href="https://blog.golang.org/protobuf-apiv2" target="_blank" rel="noopener noreferrer">protobuf apiv2</a> to
parse the http options, generating the REST bindings.
The best part is that it does this on the fly.
No extra <code>protoc</code> options or dealing with the generated runtime code.
It can do this via server side reflection too, making it a proxy that adapts to the server changes without having to reboot.
Although the most useful case I&#x27;ve had is for the server to run both the gRPC service and the http REST service.</p><p>Below is my function that serves on the listener until failure:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">func (s *Server) Serve(l net.Listener) error {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sigChan := make(chan os.Signal, 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    m := cmux.New(l)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    grpcL := m.Match(cmux.HTTP2HeaderField(&quot;content-type&quot;, &quot;application/grpc&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    httpL := m.Match(cmux.Any())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    zgl := zapgrpc.NewLogger(s.log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    grpclog.SetLoggerV2(zgl)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    gs := grpc.NewServer(grpc.UnaryInterceptor(s.unaryInterceptor))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pb.RegisterAppServer(gs, s)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    longrunning.RegisterOperationsServer(gs, s)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hd := &amp;larking.Handler{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        UnaryInterceptor: s.unaryInterceptor,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err := hd.RegisterServiceByName(&quot;app.api.Services&quot;, s); err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if err := hd.RegisterServiceByName(&quot;google.longrunning.Operations&quot;, s); err != nil {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mux := http.NewServeMux()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if s.debug {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        s.log.Info(&quot;debug enabled&quot;, zap.String(&quot;path&quot;, &quot;/debug/pprof/&quot;))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mux.HandleFunc(&quot;/debug/pprof/&quot;, pprof.Index)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mux.HandleFunc(&quot;/debug/pprof/cmdline&quot;, pprof.Cmdline)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mux.HandleFunc(&quot;/debug/pprof/profile&quot;, pprof.Profile)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mux.HandleFunc(&quot;/debug/pprof/symbol&quot;, pprof.Symbol)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        mux.HandleFunc(&quot;/debug/pprof/trace&quot;, pprof.Trace)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mux.Handle(&quot;/api/&quot;, http.StripPrefix(&quot;/api/&quot;, hd)) // Firebase hosting restrictions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    mux.Handle(&quot;/&quot;, hd)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    hs := &amp;http.Server{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Handler: mux,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    errs := make(chan error, 3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    go func() { errs &lt;- gs.Serve(grpcL) }()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    defer gs.Stop()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    go func() { errs &lt;- hs.Serve(httpL) }()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    defer hs.Close()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    go func() { errs &lt;- m.Serve() }()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    s.log.Info(&quot;listening&quot;, zap.String(&quot;address&quot;, l.Addr().String()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    select {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case err := &lt;-errs:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case _ = &lt;-sigChan:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return nil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="protoc"></a>Protoc<a class="hash-link" href="#protoc" title="Direct link to heading">#</a></h3><p>Protoc build command:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">protoc --go_out=paths=source_relative:. --go-grpc_out=paths=source_relative:. --ts_proto_out=. --ts_proto_opt=esModuleInterop=true,useDate=string apipb/*.proto</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To keep the frontend in-sync with the backend I use a typescript integration from <code>ts_proto</code>.
Docs <a href="https://github.com/stephenh/ts-proto" target="_blank" rel="noopener noreferrer">here</a>.
One unsolved problem is the generation of calling code.
I don&#x27;t have autogenerated handlers for calling the API yet.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="layout"></a>Layout<a class="hash-link" href="#layout" title="Direct link to heading">#</a></h2><p>I like flat layouts. Specially for small projects. I think it greatly simplifies it.
Everything is visible, nothing is hidden away in the depths.
It&#x27;s realy not a big deal how things are laid out but it helps to have a structure.
Web app projects are tightly integrated between the frontend and backend.
The API is used to &quot;decouple&quot; the two, but if you want to change the API you need to ensure both still work.
I&#x27;ve found it nice to have the backend/frontend code living close together.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">.firebase</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.firebaserc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.gitignore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">.next</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">README.md</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apipb</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ api.pb.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ api.proto</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ api.ts</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ api_grpc.pb.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$APP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ server.go (go application files)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ resources.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ resources_test.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ resources.tsx (javascript code resources API)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cmd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ appname</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    âââ main.go</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">components</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ Button.tsx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">firebase.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">firestore-debug.log</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">firestore.rules</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">go.mod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">go.sum</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">next.config.js</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">node_modules</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">package.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pages</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ _document.tsx (html document settings)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ _app.tsx (app settings)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ index.tsx (home page)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">postcss.config.js</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ ... (images, etc)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">styles</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">âââ global.css</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tailwind.config.js</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tsconfig.json</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h2><p>Googles <a href="https://github.com/google/ko" target="_blank" rel="noopener noreferrer"><code>ko</code></a> is great!
One command deployment to gcloud run:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">gcloud --project $PROJECT run deploy --image=$(KO_DOCKER_REPO=gcr.io/$PROJECT/$APP ko publish ./cmd/$APP) --platform managed $APP</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I&#x27;ve used bazel before and wanted to reuse it in projects.
However, most of the time I find it gets in the way more than anything.
It doesn&#x27;t play nicely with the localy tools so editors and bazel constantly rebuild your code.
Protoc support works, but I&#x27;ve had it break constantly on multiple upgrades.
Bazel server isn&#x27;t light either.
I&#x27;m working with an older mac that needs all the ram it can get.
So for now I&#x27;ve been happy with <code>ko</code>.</p><p>For projects that require <code>cgo</code> I use <code>zig</code>.
Docs <a href="https://dev.to/kristoff/zig-makes-go-cross-compilation-just-work-29ho" target="_blank" rel="noopener noreferrer">here</a>.
I&#x27;ve then been using bazel for only building the container iamges and deploying them.
This is sub optimal.
So I have a new project <code>laze</code>!
<code>laze</code> is a local tool friendly, build graph exectutor.
It tries to be a simple version of bazel.
Docs for it <a href="https://github.com/emcfarlane/laze" target="_blank" rel="noopener noreferrer">here</a>.
I&#x27;ll do a writeup once I get some more core features added.</p><p>For the frontend:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">npm run export &amp;&amp; firebase deploy</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Firebase code need to know about the proxy.</p><p><code>firebase.json</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;hosting&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;public&quot;: &quot;out/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;ignore&quot;: [&quot;firebase.json&quot;, &quot;**/.*&quot;, &quot;**/node_modules/**&quot;],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;rewrites&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;source&quot;: &quot;/api/**&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;run&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          &quot;serviceId&quot;: &quot;$APP&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          &quot;region&quot;: &quot;europe-west1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;source&quot;: &quot;/login&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;destination&quot;: &quot;/login.html&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;firestore&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;rules&quot;: &quot;firestore.rules&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;emulators&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;hosting&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;port&quot;: 5000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;firestore&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;port&quot;: &quot;8080&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;ui&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;enabled&quot;: true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;host&quot;: &quot;0.0.0.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;port&quot;: 4000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div></section></article><div><a href="https://github.com/emcfarlane/emcfarlane.github.io/edit/master/blog/2021-06-01-webapps.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/sqlitex"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« SQLite Search</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/goldfish"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Goldfish Memory Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#nextjs-guide" class="table-of-contents__link">NextJS Guide</a><ul><li><a href="#setup-nextjs" class="table-of-contents__link">Setup Next.js</a></li><li><a href="#setup-typescript" class="table-of-contents__link">Setup Typescript</a></li><li><a href="#setup-pwa" class="table-of-contents__link">Setup PWA</a></li><li><a href="#setup-tailwindcss" class="table-of-contents__link">Setup Tailwindcss</a></li><li><a href="#setup-darkmode" class="table-of-contents__link">Setup Darkmode</a></li></ul></li><li><a href="#firebase" class="table-of-contents__link">Firebase</a></li><li><a href="#api" class="table-of-contents__link">API</a><ul><li><a href="#larking" class="table-of-contents__link">Larking</a></li><li><a href="#protoc" class="table-of-contents__link">Protoc</a></li></ul></li><li><a href="#layout" class="table-of-contents__link">Layout</a></li><li><a href="#deployment" class="table-of-contents__link">Deployment</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Edward McFarlane.</div></div></div></footer></div>
<script src="/styles.3afe586c.js"></script>
<script src="/runtime~main.00845c9c.js"></script>
<script src="/main.74982311.js"></script>
<script src="/1.48443e6e.js"></script>
<script src="/2.0385acc6.js"></script>
<script src="/ccc49370.c39886c3.js"></script>
<script src="/ffe4a5f6.6803eb02.js"></script>
<script src="/80bd3654.fd062ed7.js"></script>
</body>
</html>