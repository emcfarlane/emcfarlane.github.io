<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Edward McFarlane Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Edward McFarlane Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><title data-react-helmet="true">SQLite Search | Edward McFarlane</title><meta data-react-helmet="true" property="og:title" content="SQLite Search | Edward McFarlane"><meta data-react-helmet="true" name="description" content="For many projects FTS is now a requirement."><meta data-react-helmet="true" property="og:description" content="For many projects FTS is now a requirement."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.5bc33aa8.css">
<link rel="preload" href="/styles.3afe586c.js" as="script">
<link rel="preload" href="/runtime~main.00845c9c.js" as="script">
<link rel="preload" href="/main.74982311.js" as="script">
<link rel="preload" href="/1.48443e6e.js" as="script">
<link rel="preload" href="/2.0385acc6.js" as="script">
<link rel="preload" href="/ccc49370.c39886c3.js" as="script">
<link rel="preload" href="/ffe4a5f6.6803eb02.js" as="script">
<link rel="preload" href="/f2481342.46a35310.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Edward McFarlane</strong></a></div><div class="navbar__items navbar__items--right"><a href="https://www.linkedin.com/in/edward-mcfarlane-b5493375/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-linkedin header-logo"></a><a href="https://twitter.com/EdwardMcFarlane" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter header-logo"></a><a href="https://www.instagram.com/edwardmcfarlane/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-instagram header-logo"></a><a href="https://github.com/emcfarlane" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github header-logo"></a><span class="displayOnlyInLargeViewport_2N3Q" aria-label="Dark mode toggle"></span></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/edward.png" alt="Pic of me" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Edward McFarlane</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://www.linkedin.com/in/edward-mcfarlane-b5493375/" target="_blank" rel="noopener noreferrer" class="menu__link header-linkedin header-logo"></a></li><li class="menu__list-item"><a href="https://twitter.com/EdwardMcFarlane" target="_blank" rel="noopener noreferrer" class="menu__link header-twitter header-logo"></a></li><li class="menu__list-item"><a href="https://www.instagram.com/edwardmcfarlane/" target="_blank" rel="noopener noreferrer" class="menu__link header-instagram header-logo"></a></li><li class="menu__list-item"><a href="https://github.com/emcfarlane" target="_blank" rel="noopener noreferrer" class="menu__link header-github header-logo"></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a aria-current="page" class="sidebarItemLink_v5H9 sidebarItemLinkActive_1anX" href="/sqlitex">SQLite Search</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/webapps">A Web App Framework</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/goldfish">Goldfish Memory</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/swash-plate">Cyclic/Collective Pitch Mixing</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/ipad-dev">An iPad with Tailscale</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">SQLite Search</h1><div class="margin-vert--md"><time datetime="2021-08-01T00:00:00.000Z" class="blogPostDate_Ta7i">August 1, 2021  · 4 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"></div></div></header><section class="markdown"><p>For many projects FTS is now a requirement.
SQLite&#x27;s <a href="https://www.sqlite.org/fts5.html" target="_blank" rel="noopener noreferrer">fts5 extension</a> provides full-text search (fts) functionality that&#x27;s simple and fast.
Here I document a solution for serverless applications that can run SQLite indexes in memory for serving fts requests.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="data"></a>Data<a class="hash-link" href="#data" title="Direct link to heading">#</a></h2><p>My data is books. A 20 byte ID, a title, an array of authors and the publish year ~ 50-100 bytes per book.
Data size per item is a very important optimisation as it will determine the minimum size of your indexes.
The smaller the better.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="building-the-index"></a>Building the index<a class="hash-link" href="#building-the-index" title="Direct link to heading">#</a></h2><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> VIRTUAL </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> books_search </span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"> fts5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> authors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">year</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Queries can now be run returning the book ID&#x27;s title and their ranking:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> rank </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> books_search</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> title </span><span class="token keyword" style="font-style:italic">MATCH</span><span class="token plain"> $title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> rank </span><span class="token keyword" style="font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>150K books can be stored in a changeset file of around 22 MB.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="running-serverless"></a>Running Serverless<a class="hash-link" href="#running-serverless" title="Direct link to heading">#</a></h2><p>The usual way to use these indexes would be to store the data on disk and have
SQLite query the disk directly.
Going to serverless we lose the option for disk IO and have to use the cloud provided storage solutions.
We can therefore run the SQLite index in-memory, fetching the data when the table is needed.</p><p>In my case I&#x27;m running a go application under google cloud run.
Here I store the changesets under google&#x27;s cloud storage and apply them as a changeset.</p><p>The library I used for go is <a href="https://pkg.go.dev/crawshaw.io/sqlite" target="_blank" rel="noopener noreferrer">crawshaw.io/sqlite</a>,
which importantly supports sqlite&#x27;s session extensions.
Below is a snippet on how to apply the sqlite index to an in memory database:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-go codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">filterFn </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tn </span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">conflictFn </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ct sqlite</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ConflictType</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> ci sqlite</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ChangesetIter</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> sqlite</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ConflictAction </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> sqlite</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">SQLITE_CHANGESET_ABORT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> bkt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">NewReader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">defer</span><span class="token plain"> blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">var</span><span class="token plain"> r io</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Reader</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">r </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> blob</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> strings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">HasSuffix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;.gz&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  gr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> gzip</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">NewReader</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">defer</span><span class="token plain"> gr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  r </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> gr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">ChangesetApply</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> filterFn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> conflictFn</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> err </span><span class="token operator" style="color:rgb(137, 221, 255)">!=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>We can then apply the changeset when a search query is run.
The first query will be slow, downloading the index and applying it.
But subsequent queries will run very quickly on the in memory indexes.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="going-smaller"></a>Going Smaller<a class="hash-link" href="#going-smaller" title="Direct link to heading">#</a></h2><p>The above worked great on a small dataset of around 150K books at 22 MB.
However, going to a million books upped the index size to 192 MB.
A bit on the heavy side for cloud run&#x27;s RAM usuage.
To get a reasonable larger dataset we can compress, or more accurately throw away, more of the data.
SQLite <code>fts5</code> tables have a <code>content</code> option. This allows you to specify the backing table for the search index.
Setting <code>content=&#x27;&#x27;</code> creates a contentless table, the columns won&#x27;t be available under SQLite.</p><p>Importantly for contentless fts tables we now need to set the <code>rowid</code> on inserts.
We must have an explicit <code>rowid INTEGER PRIMARY KEY</code>.
This is to avoid SQLite VACUUM rearrange the rowids and corrupting what the search index data points to.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> books_index </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rowid </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">KEY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bookid </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INDEX</span><span class="token plain"> idx_books_index </span><span class="token keyword" style="font-style:italic">ON</span><span class="token plain"> books_index </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">bookid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> VIRTUAL </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> books_search </span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"> fts5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  title</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> authors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">year</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> content</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Queries can now be run returning the book ID&#x27;s and their ranking:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-sql codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> bookid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> rank </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> books_search S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"> books_index I </span><span class="token keyword" style="font-style:italic">ON</span><span class="token plain"> S</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">rowid </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> I</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">rowid</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> title </span><span class="token keyword" style="font-style:italic">MATCH</span><span class="token plain"> $title</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> rank </span><span class="token keyword" style="font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Content isn&#x27;t available via the index so all information must be fetchable based
on the <code>bookid</code>.</p><p>1 Million books can now be stored in 91 MB.
Going further we can compress the index on disk with gzip for a 47 MB gzipped file.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="alternatives"></a>Alternatives<a class="hash-link" href="#alternatives" title="Direct link to heading">#</a></h2><p>Alternatively serverless solutions like <a href="https://www.algolia.com/" target="_blank" rel="noopener noreferrer">Algolia</a> are great and allow serverless applications to remain stateless without worrying about the implementation.
SQLite also has some interesting solutions on running it client side. This is done by compiling SQLite to wasm and dynamically fetching parts of the database from storage when queries are run (<a href="https://phiresky.github.io/blog/2021/hosting-sqlite-databases-on-github-pages/" target="_blank" rel="noopener noreferrer">write up</a>).
For small and simple application running the SQLite index as part of the application was exciting to see how easy it is to get a simple workable solution.</p></section></article><div><a href="https://github.com/emcfarlane/emcfarlane.github.io/edit/master/blog/2021-08-01-sqlite.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/webapps"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">A Web App Framework »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#data" class="table-of-contents__link">Data</a></li><li><a href="#building-the-index" class="table-of-contents__link">Building the index</a></li><li><a href="#running-serverless" class="table-of-contents__link">Running Serverless</a></li><li><a href="#going-smaller" class="table-of-contents__link">Going Smaller</a></li><li><a href="#alternatives" class="table-of-contents__link">Alternatives</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 Edward McFarlane.</div></div></div></footer></div>
<script src="/styles.3afe586c.js"></script>
<script src="/runtime~main.00845c9c.js"></script>
<script src="/main.74982311.js"></script>
<script src="/1.48443e6e.js"></script>
<script src="/2.0385acc6.js"></script>
<script src="/ccc49370.c39886c3.js"></script>
<script src="/ffe4a5f6.6803eb02.js"></script>
<script src="/f2481342.46a35310.js"></script>
</body>
</html>